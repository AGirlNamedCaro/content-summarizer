#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/content_summarizer"

url = ARGV[0]
demo_mode = ARGV.include?("--demo")

if url.nil? || url.empty?
  puts "âŒ Error: No URL provided"
  puts "Usage: bin/summarize <URL> [--demo]"
  puts "\nOptions:"
  puts "  --demo    Use fake summarizer (no API key needed)"
  exit 1
end

if demo_mode
  puts "ğŸ­ DEMO MODE - Using fake summarizer"

  class FakeAPIClient
    def summarize(text)
      "DEMO SUMMARY: This is a simulated summary of the article. " \
      "In production, this would be generated by Claude AI. " \
      "The article discusses: #{text[0..200]}..."
    end
  end

  fake_summarizer = ContentSummarizer::Summarizer.new(api_client: FakeAPIClient.new)
  service = ContentSummarizer::ContentSummarizationService.new(
    api_key: "demo",
    summarizer: fake_summarizer,
  )
else
  api_key = ENV["CLAUDE_API_KEY"]

  if api_key.nil? || api_key.empty?
    puts "âŒ Error: CLAUDE_API_KEY not set"
    puts "Tip: Use --demo flag to test without API key"
    exit 1
  end

  cache = ContentSummarizer::Cache.new
  service = ContentSummarizer::ContentSummarizationService.new(
    api_key: api_key,
    cache: cache,
  )
end

puts "ğŸš€ Starting summarization..."
puts "ğŸ“° URL: #{url}"
puts

begin
  summary = service.summarize_url(url)

  puts "\n" + "=" * 60
  puts "ğŸ“ SUMMARY"
  puts "=" * 60
  puts summary
  puts "=" * 60
rescue ContentSummarizer::Error => e
  puts "âŒ Error: #{e.message}"
  exit 1
end
